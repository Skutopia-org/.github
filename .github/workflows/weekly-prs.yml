name: 'Weekly change log'

# Turning changelog off
# on:
#   schedule:
#     - cron: "0 5 * * 1" 

jobs:
  getPrs:
    name: Get PRs and send notification
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.SEARCH_GH_ACCESS_TOKEN_ALL }}
    steps:
    - uses: actions/setup-node@v3
      with:
        node-version: '20.x'

    - run: npm install axios
    
    - uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.SEARCH_GH_ACCESS_TOKEN_ALL }}
        script: |
          const axios = require('axios');
          
          const date = new Date();
          const oneWeekAgo = new Date(date.setDate(date.getDate() - 7)).toISOString()
          
          const repoMap = [
              {repo: "waretopia",emoji: ":package:", friendlyName: "Fulfilment Centre"},
              {repo: "skutopia",emoji: ":skutopia-logo_icon-gradient:", friendlyName: "Shipping Platform"},
              {repo: "notification-service", emoji: ":incoming_envelope:", friendlyName: "Notification Domain"},
              {repo: "datatopia", emoji: ":datastudio:", friendlyName: "Datatopia"},
              {repo: "shared-infrastructure", emoji: ":building_construction:", friendlyName: "Shared Infrastructure"},
              {repo: "billing-domain", emoji: ":moneybag:", friendlyName: "Billing Domain"},
              {repo: "architecture-decision-records", emoji: ":spiral_note_pad:", friendlyName: "Architecture Decision Records"},
              {repo: "ecommerce-domain", emoji: ":ecommerce:", friendlyName: "E-Commerce Domain"},
              {repo: "dataform", emoji: ":datastudio:", friendlyName: "Dataform"},
              {repo: "carrier-domain", emoji: ":truck:", friendlyName: "Carrier Domain"},
              {repo: "skutilities", emoji: ":utility:", friendlyName: "Skutilities"},
              {repo: "zod-http-schemas", emoji: ":zod:", friendlyName: "Zod HTTP Schemas"},
              {repo: "analytics", emoji: ":analytics:", friendlyName: "Analytics"},
              {repo: ".github", emoji: ":github:", friendlyName: "GitHub Shared"},
              {repo: "skutopia-logger", emoji: ":pencil:", friendlyName: "Skutopia Logger"},
              {repo: "pulumi-deployment-runner", emoji: ":pulumi-intensifies:", friendlyName: "Pulumi Deployment Runner"},
              {repo: "docker-swarm-cluster", emoji: ":docker:", friendlyName: "Docker Swarm"}
          ]
          
          const repos = await github.rest.repos.listForOrg({
            org: 'Skutopia-org',
          });
          
          const pullRequests = await Promise.all(repos.data.map(async (r, i)  => { 
            const result = await github.rest.search.issuesAndPullRequests({
              q: `repo:${r.full_name}+is:pr+is:merged+closed:>${oneWeekAgo}`,
              })
              
            const shortRepoName = r.full_name.split("/").pop()
            
            const prs = {
              repo: `${repoMap.find(i => i?.repo === shortRepoName)?.emoji || ''}  ${repoMap.find(i => i?.repo === shortRepoName)?.friendlyName || shortRepoName}`,
              prs: result.data.items.map(i => `â€¢ ${i.title}${i.labels.map(l => ` [${l.name}]`).filter((n) => !n.includes('size'))}`)
            }
          
            return prs
          }));
          
          const filteredPullRequests = pullRequests.filter(pr => pr.prs.length !== 0 );
          
          const slackBlocks = filteredPullRequests.map(i => {
              const titleBlock = {
                  type: "section",
                  text:{
                      type: "mrkdwn",
                      text: ` *${i.repo}*`}
                  };
              const prBlock =  {
                  type: 
                  "section",
                  text:{
                      type: "mrkdwn",
                      text: i.prs.join('\n')
                  }
              }
              const divideBlock =  {
                  "type": "divider"
              }
              return [titleBlock,prBlock,divideBlock]
          })
          
          const headerBlock = [{type: "header",text:{type: "plain_text",text: ":rockets_fire: What we have shipped in the last week! :rockets_fire:"}},{"type": "divider"}]
          
          axios.post('https://hooks.slack.com/services/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',{
              blocks: headerBlock.concat(slackBlocks.flatMap(b => b))
          },{headers: {
              "Content-Type": 'application/json'
          }})


        
