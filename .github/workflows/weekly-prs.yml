name: 'Weekly change log'

on:
  schedule:
    - cron: "0 5 * * 1" 

jobs:
  getPrs:
    name: Get PRs
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.SEARCH_GH_ACCESS_TOKEN_ALL }}
    steps:
    - name: 'Setup jq'
      uses: dcarbone/install-jq-action@v2
      
    - name: Get PRs
      id: pull_requests
      run: |
        URI="https://api.github.com"
        API_HEADER="Accept: application/vnd.github.v3+json"
        AUTH_HEADER="Authorization: token ${GITHUB_TOKEN}"

        date=`date +%Y-%m-%d'T'%H:%M'Z' -d "7 days ago"`
        
        SKUTOPIA_PRS_RESPONSE=$(curl -sSL -H "${AUTH_HEADER}" -H "${API_HEADER}" "${URI}/search/issues?q=repo:Skutopia-org/skutopia+is:pr+is:merged+closed:>$date")
        # SKUTOPIA_PRS=$(echo "$SKUTOPIA_PRS_RESPONSE" | jq '.items[] | "\(.title) - \(.url) [\(.labels[] | select(.name | contains("size") | not ) | .name)]"')
        SKUTOPIA_PRS=$(echo "$SKUTOPIA_PRS_RESPONSE" | jq -r '.items[] | "• \(.title) - [\(.labels[] | select(.name | contains("size") | not ) | .name)]"')

        WARETOPIA_PRS_RESPONSE=$(curl -sSL -H "${AUTH_HEADER}" -H "${API_HEADER}" "${URI}/search/issues?q=repo:Skutopia-org/waretopia+is:pr+is:merged+closed:>$date")
        # WARETOPIA_PRS=$(echo "$WARETOPIA_PRS_RESPONSE" | jq '.items[] | "\(.title) - \(.url) [\(.labels[] | select(.name | contains("size") | not ) | .name)]"')
        WARETOPIA_PRS=$(echo "$WARETOPIA_PRS_RESPONSE" | jq -r '.items[] | "• \(.title) - [\(.labels[] | select(.name | contains("size") | not ) | .name)]"')

        ECOMM_PRS_RESPONSE=$(curl -sSL -H "${AUTH_HEADER}" -H "${API_HEADER}" "${URI}/search/issues?q=repo:Skutopia-org/ecommerce-domain+is:pr+is:merged+closed:>$date")
        # ECOMM_PRS=$(echo "$ECOMM_PRS_RESPONSE" | jq '.items[] | "\(.title) - \(.url) [\(.labels[] | select(.name | contains("size") | not ) | .name)]"')
        ECOMM_PRS=$(echo "$ECOMM_PRS_RESPONSE" | jq -r '.items[] | "• \(.title) - [\(.labels[] | select(.name | contains("size") | not ) | .name)]"')
        
        BILLING_PRS_RESPONSE=$(curl -sSL -H "${AUTH_HEADER}" -H "${API_HEADER}" "${URI}/search/issues?q=repo:Skutopia-org/billing-domain+is:pr+is:merged+closed:>$date")
        # BILLING_PRS=$(echo "$BILLING_PRS_RESPONSE" | jq '.items[] | "\(.title) - \(.url) [\(.labels[] | select(.name | contains("size") | not ) | .name)]"')
        BILLING_PRS=$(echo "$BILLING_PRS_RESPONSE" | jq -r '.items[] | "• \(.title) - [\(.labels[] | select(.name | contains("size") | not ) | .name)]"')

        #Slack doesn't like blocks with null so need to do some conditional checking and setting a blank space
        SKUTILITIES_PRS_RESPONSE=$(curl -sSL -H "${AUTH_HEADER}" -H "${API_HEADER}" "${URI}/search/issues?q=repo:Skutopia-org/skutilities+is:pr+is:merged+closed:>$date")
        echo $SKUTILITIES_PRS_RESPONSE
        if [[ $SKUTILITIES_PRS_RESPONSE == *'"total_count": 0'* ]]; then
          SKUTILITIES_PRS=' '
        else  
          SKUTILITIES_PRS=$(echo "$SKUTILITIES_PRS_RESPONSE" | jq -r '.items[] | "• \(.title) - [\(.labels[] | select(.name | contains("size") | not ) | .name)]"')
        fi

        LOGGER_PRS_RESPONSE=$(curl -sSL -H "${AUTH_HEADER}" -H "${API_HEADER}" "${URI}/search/issues?q=repo:Skutopia-org/skutopia-logger+is:pr+is:merged+closed:>$date")
        if [[ $LOGGER_PRS_RESPONSE == *'"total_count": 0'* ]]; then
          LOGGER_PRS=' '
        else  
          LOGGER_PRS=$(echo "$LOGGER_PRS_RESPONSE" | jq -r '.items[] | "• \(.title) - [\(.labels[] | select(.name | contains("size") | not ) | .name)]"')
        fi

        INFRA_PRS_RESPONSE=$(curl -sSL -H "${AUTH_HEADER}" -H "${API_HEADER}" "${URI}/search/issues?q=repo:Skutopia-org/shared-infrastructure+is:pr+is:merged+closed:>$date")
        if [[ $INFRA_PRS_RESPONSE == *'"total_count": 0'* ]]; then
          INFRA_PRS=' '
        else  
          INFRA_PRS=$(echo "$INFRA_PRS_RESPONSE" | jq -r '.items[] | "• \(.title) - [\(.labels[] | select(.name | contains("size") | not ) | .name)]"')
        fi

        
        # Contains above conditional ones
        # jq -r -n --arg SKUTOPIA_PRS "$SKUTOPIA_PRS" --arg WARETOPIA_PRS "$WARETOPIA_PRS" --arg BILLING_PRS "$BILLING_PRS" --arg ECOMM_PRS "$ECOMM_PRS" --arg SKUTILITIES_PRS "$SKUTILITIES_PRS" --arg LOGGER_PRS "$LOGGER_PRS" --arg INFRA_PRS "$INFRA_PRS" '{blocks: [{type: "header",text:{type: "plain_text",text: ":rockets_fire: What we have deployed in the last week! :rockets_fire:"}},{"type": "divider"},{type: "section",text:{type: "mrkdwn",text: ":skutopia-logo_icon-gradient: *Shipping Platform*"}},{type: "section",text:{type: "mrkdwn",text: $SKUTOPIA_PRS}},{"type": "divider"},{type: "section",text:{type: "mrkdwn",text: ":package: *Fulfilment Centre*"}},{type: "section",text:{type: "mrkdwn",text: $WARETOPIA_PRS}},{"type": "divider"},{type: "section",text:{type: "mrkdwn",text: ":moneybag: *Billing Domain*"}},{type: "section",text:{type: "mrkdwn",text: $BILLING_PRS}},{"type": "divider"},{type: "section",text:{type: "mrkdwn",text: ":ecommerce: *Ecommerce Domain* "}},{type: "section",text:{type: "mrkdwn",text: $ECOMM_PRS}},{"type": "divider"},{type: "section",text:{type: "mrkdwn",text: ":building_construction: *MISC* "}},{type: "section",text:{type: "mrkdwn",text: $SKUTILITIES_PRS}},{type: "section",text:{type: "mrkdwn",text: $LOGGER_PRS}},{type: "section",text:{type: "mrkdwn",text: $INFRA_PRS}},{"type": "divider"}]}' > post.json
        
        jq -r -n --arg SKUTOPIA_PRS "$SKUTOPIA_PRS" --arg WARETOPIA_PRS "$WARETOPIA_PRS" --arg BILLING_PRS "$BILLING_PRS" --arg ECOMM_PRS "$ECOMM_PRS" '{blocks: [{type: "header",text:{type: "plain_text",text: ":rockets_fire: What we have shipped in the last week! :rockets_fire:"}},{"type": "divider"},{type: "section",text:{type: "mrkdwn",text: ":skutopia-logo_icon-gradient: *Shipping Platform*"}},{type: "section",text:{type: "mrkdwn",text: $SKUTOPIA_PRS}},{"type": "divider"},{type: "section",text:{type: "mrkdwn",text: ":package: *Fulfilment Centre*"}},{type: "section",text:{type: "mrkdwn",text: $WARETOPIA_PRS}},{"type": "divider"},{type: "section",text:{type: "mrkdwn",text: ":moneybag: *Billing Domain*"}},{type: "section",text:{type: "mrkdwn",text: $BILLING_PRS}},{"type": "divider"},{type: "section",text:{type: "mrkdwn",text: ":ecommerce: *Ecommerce Domain* "}},{type: "section",text:{type: "mrkdwn",text: $ECOMM_PRS}},{"type": "divider"}]}' > post.json
        cat post.json

        curl -X POST -H 'Content-type: application/json' --data @post.json https://hooks.slack.com/services/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



        
