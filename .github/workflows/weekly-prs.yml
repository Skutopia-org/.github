name: 'Weekly change log'

on:
  push:

jobs:
  getPrs:
    name: Get PRs
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.SEARCH_GH_ACCESS_TOKEN_ALL }}
    steps:
    - uses: actions/setup-node@v3
      with:
        node-version: '20.x'

    - run: npm install axios
    
    - uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.SEARCH_GH_ACCESS_TOKEN_ALL }}
        script: |
          const axios = require('axios');
          
          const date = new Date();
          const oneWeekAgo = new Date(date.setDate(date.getDate() - 7)).toISOString()
          
          const emojis = [
              {repo: "waretopia",emoji: ":package:"},
              {repo: "skutopia",emoji: ":skutopia-logo_icon-gradient:"},
              {repo: "notification-service", emoji: ":incoming_envelope:"},
              {repo: "datatopia", emoji: ":datastudio:"},
              {repo: "shared-infrastructure", emoji: ":building_construction:"},
              {repo: "billing-domain", emoji: ":moneybag:"},
              {repo: "architecture-decision-records", emoji: ":spiral_note_pad:"},
              {repo: "ecommerce-domain", emoji: ":ecommerce:"},
              {repo: "dataform", emoji: ":datastudio:"},
              {repo: "carrier-domain", emoji: ":truck:"},
              {repo: "skutilities", emoji: ":utility:"}
          ]
          
          const repos = await github.rest.repos.listForOrg({
            org: 'Skutopia-org',
          });
          
          const pullRequests = await Promise.all(repos.data.map(async (r, i)  => { 
            const result = await github.rest.search.issuesAndPullRequests({
              q: `repo:${r.full_name}+is:pr+is:merged+closed:>${oneWeekAgo}`,
              })
            const friendlyRepoName = r.full_name.split("/").pop()
            const prs = {
              repo: `${emojis.find(e => e?.repo === friendlyRepoName)?.emoji || ''} ${friendlyRepoName}`,
              prs: result.data.items.map(i => `â€¢ ${i.title} - ${i.labels.map(l => l.name).filter((n) => !n.includes('size'))}`)
            }
          
            return prs
          }));
          
          const filteredPullRequests = pullRequests.filter(pr => pr.prs.length !== 0 );
          
          const slackBlocks = filteredPullRequests.map(i => {
              const titleBlock = {
                  type: "section",
                  text:{
                      type: "mrkdwn",
                      text: ` *${i.repo}*`}
                  };
              const prBlock =  {
                  type: 
                  "section",
                  text:{
                      type: "mrkdwn",
                      text: i.prs.join('\n')
                  }
              }
              const divideBlock =  {
                  "type": "divider"
              }
              return [titleBlock,prBlock,divideBlock]
          })
          
          const headerBlock = [{type: "header",text:{type: "plain_text",text: ":rockets_fire: What we have shipped in the last week! :rockets_fire:"}},{"type": "divider"}]
          
          axios.post('https://hooks.slack.com/services/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',{
              blocks: headerBlock.concat(slackBlocks.flatMap(b => b))
          },{headers: {
              "Content-Type": 'application/json'
          }})

        
