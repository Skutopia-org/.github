name: 'Weekly change log'

on:
  push:

jobs:
  getPrs:
    name: Get PRs
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.SEARCH_GH_ACCESS_TOKEN_ALL }}
    steps:
    - name: 'Setup jq'
      uses: dcarbone/install-jq-action@v2
      
    - name: Get PRs
      run: |
        URI="https://api.github.com"
        API_HEADER="Accept: application/vnd.github.v3+json"
        AUTH_HEADER="Authorization: token ${GITHUB_TOKEN}"

        date=`date +%Y-%m-%d'T'%H:%M'Z' -d "7 days ago"`
        
        SKUTOPIA_PRS_RESPONSE=$(curl -sSL -H "${AUTH_HEADER}" -H "${API_HEADER}" "${URI}/search/issues?q=repo:Skutopia-org/skutopia+is:pr+is:merged+closed:>$date")
        SKUTOPIA_PRS=$(echo "$SKUTOPIA_PRS_RESPONSE" | jq -r --arg date "$date" '.items[] | "\(.title) - \(.url) [\(.labels[] | select(.name | contains("size") | not ) | .name)]\n"')
        echo $SKUTOPIA_PRS

        
