name: 'Weekly change log'

on:
  push:

jobs:
  getPrs:
    name: Get PRs
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.SEARCH_GH_ACCESS_TOKEN_ALL }}
    steps:
    - name: 'Setup jq'
      uses: dcarbone/install-jq-action@v2
      
    - name: Get PRs
      run: |
        URI="https://api.github.com"
        API_HEADER="Accept: application/vnd.github.v3+json"
        AUTH_HEADER="Authorization: token ${GITHUB_TOKEN}"

        date=`date +%Y-%m-%d'T'%H:%M'Z' -d "7 days ago"`
        echo $date

        
        PRS=$(curl -sSL -H "${AUTH_HEADER}" -H "${API_HEADER}" "${URI}/search/issues?q=repo:Skutopia-org/skutopia+is:pr+is:merged")
        echo "$PRS" | jq -r --arg date "$date" '.items[] | "\(.title) - \(.url) [\(.labels[] | select(.closed_at > $date) | select(.name | contains("size") | not ) | .name)]"'

        
# $ json='[{"genre":"deep house"}, {"genre": "progressive house"}, {"genre": "dubstep"}]'
# $ echo "$json" | jq -c '.[] | select(.genre | contains("house"))'
# {"genre":"deep house"}
# {"genre":"progressive house"}
